import 'dart:async';
import 'package:flutter/material.dart';
import 'package:firebase_auth/firebase_auth.dart';

class EmailVerificationPendingScreen extends StatefulWidget {
  const EmailVerificationPendingScreen({super.key});

  @override
  State<EmailVerificationPendingScreen> createState() => _EmailVerificationPendingScreenState();
}

class _EmailVerificationPendingScreenState extends State<EmailVerificationPendingScreen> {
  bool canResendEmail = true;
  int secondsRemaining = 0;
  Timer? timer;

  @override
  void dispose() {
    timer?.cancel();
    super.dispose();
  }

  void startTimer() {
    setState(() {
      canResendEmail = false;
      secondsRemaining = 60; // Espera de 1 minuto
    });

    timer = Timer.periodic(const Duration(seconds: 1), (timer) {
      if (secondsRemaining == 0) {
        setState(() {
          canResendEmail = true;
          timer.cancel();
        });
      } else {
        setState(() {
          secondsRemaining--;
        });
      }
    });
  }

  Future<void> resendVerification() async {
    try {
      await FirebaseAuth.instance.currentUser?.sendEmailVerification();
      startTimer();
      ScaffoldMessenger.of(context).showSnackBar(
        const SnackBar(content: Text("Enlace reenviado. Revisa tu bandeja de entrada.")),
      );
    } catch (e) {
      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(content: Text("Error: Inténtalo más tarde.")),
      );
    }
  }

  @override
  Widget build(BuildContext context) {
    final user = FirebaseAuth.instance.currentUser;

    return Scaffold(
      body: Padding(
        padding: const EdgeInsets.symmetric(horizontal: 30),
        child: Column(
          mainAxisAlignment: MainAxisAlignment.center,
          children: [
            const Icon(Icons.verified_user_outlined, size: 80, color: Colors.orange),
            const SizedBox(height: 24),
            const Text("Verificación pendiente", 
              style: TextStyle(fontSize: 22, fontWeight: FontWeight.bold)),
            const SizedBox(height: 16),
            Text("Debes verificar tu correo para continuar:\n${user?.email}",
              textAlign: TextAlign.center),
            const SizedBox(height: 32),
            
            // BOTÓN DE "YA HICE CLIC"
            ElevatedButton(
              onPressed: () async {
                await user?.reload();
                // Al recargar, si ya verificó, el AuthGate lo moverá automáticamente
              },
              child: const Text("Ya verifiqué mi correo"),
            ),

            const SizedBox(height: 15),

            // BOTÓN DE REENVIAR CON TEMPORIZADOR
            TextButton(
              onPressed: canResendEmail ? resendVerification : null,
              child: Text(
                canResendEmail 
                ? "Reenviar enlace de verificación" 
                : "Reintentar en $secondsRemaining s"
              ),
            ),
            
            const SizedBox(height: 40),

            TextButton(
              onPressed: () => FirebaseAuth.instance.signOut(),
              child: const Text("Cerrar sesión", style: TextStyle(color: Colors.red)),
            ),
          ],
        ),
      ),
    );
  }
}